<!DOCTYPE html>
<html>
<head>
    <title>PSA API Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        select { padding: 8px; margin: 10px; width: 300px; display: block; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>PSA API Integration Test</h1>
    
    <div class="debug" id="debug">Ready to test PSA API...\n</div>
    
    <select id="province" onchange="testUpdateCities()">
        <option value="">Loading provinces...</option>
    </select>
    
    <select id="city" disabled>
        <option value="">Select City/Municipality</option>
    </select>
    
    <select id="barangay" disabled>
        <option value="">Select Barangay</option>
    </select>

    <script>
    const PSA_API_BASE = 'https://psgc.gitlab.io/api';
    
    function debug(message, type = 'info') {
        const debugDiv = document.getElementById('debug');
        const timestamp = new Date().toLocaleTimeString();
        const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
        debugDiv.innerHTML += `<span class="${className}">${timestamp}: ${message}</span>\n`;
        console.log(message);
    }

    // Initialize provinces
    async function initializeProvinces() {
        debug('Initializing provinces from PSA API...');
        
        try {
            const response = await fetch(`${PSA_API_BASE}/provinces/`);
            debug(`API Response status: ${response.status}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const provinces = await response.json();
            debug(`Received ${provinces.length} provinces`, 'success');
            
            const provinceSelect = document.getElementById('province');
            provinceSelect.innerHTML = '<option value="">Select Province</option>';
            
            // Sort and populate
            provinces.sort((a, b) => a.name.localeCompare(b.name));
            provinces.forEach(province => {
                const option = document.createElement('option');
                option.value = province.code;
                option.textContent = province.name;
                provinceSelect.appendChild(option);
            });
            
            debug('Provinces loaded successfully!', 'success');
            
        } catch (error) {
            debug(`Error loading provinces: ${error.message}`, 'error');
            document.getElementById('province').innerHTML = '<option value="">Error loading provinces</option>';
        }
    }

    // Update cities
    async function testUpdateCities() {
        const provinceSelect = document.getElementById('province');
        const citySelect = document.getElementById('city');
        const barangaySelect = document.getElementById('barangay');
        
        const selectedProvinceCode = provinceSelect.value;
        debug(`Province selected: ${selectedProvinceCode}`);
        
        if (!selectedProvinceCode) {
            citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
            citySelect.disabled = true;
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            barangaySelect.disabled = true;
            return;
        }
        
        citySelect.innerHTML = '<option value="">Loading cities...</option>';
        citySelect.disabled = true;
        barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
        barangaySelect.disabled = true;
        
        try {
            debug('Fetching cities from PSA API...');
            const response = await fetch(`${PSA_API_BASE}/cities-municipalities/`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const allCities = await response.json();
            debug(`Received ${allCities.length} total cities`);
            
            // Filter by province code
            const provinceCities = allCities.filter(city => city.provinceCode === selectedProvinceCode);
            debug(`Found ${provinceCities.length} cities for province ${selectedProvinceCode}`, 'success');
            
            citySelect.innerHTML = '<option value="">Select City/Municipality</option>';
            
            provinceCities.sort((a, b) => a.name.localeCompare(b.name));
            provinceCities.forEach(city => {
                const option = document.createElement('option');
                option.value = city.code;
                option.textContent = city.name;
                citySelect.appendChild(option);
            });
            
            citySelect.disabled = false;
            citySelect.onchange = testUpdateBarangays;
            debug('Cities loaded successfully!', 'success');
            
        } catch (error) {
            debug(`Error loading cities: ${error.message}`, 'error');
            citySelect.innerHTML = '<option value="">Error loading cities</option>';
        }
    }

    // Update barangays
    async function testUpdateBarangays() {
        const citySelect = document.getElementById('city');
        const barangaySelect = document.getElementById('barangay');
        
        const selectedCityCode = citySelect.value;
        debug(`City selected: ${selectedCityCode}`);
        
        if (!selectedCityCode) {
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            barangaySelect.disabled = true;
            return;
        }
        
        barangaySelect.innerHTML = '<option value="">Loading barangays...</option>';
        barangaySelect.disabled = true;
        
        try {
            debug('Fetching barangays from PSA API...');
            const response = await fetch(`${PSA_API_BASE}/barangays/`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const allBarangays = await response.json();
            debug(`Received ${allBarangays.length} total barangays`);
            
            // Filter by city code
            const cityBarangays = allBarangays.filter(barangay => barangay.cityCode === selectedCityCode);
            debug(`Found ${cityBarangays.length} barangays for city ${selectedCityCode}`, 'success');
            
            barangaySelect.innerHTML = '<option value="">Select Barangay</option>';
            
            cityBarangays.sort((a, b) => a.name.localeCompare(b.name));
            cityBarangays.forEach(barangay => {
                const option = document.createElement('option');
                option.value = barangay.code;
                option.textContent = barangay.name;
                barangaySelect.appendChild(option);
            });
            
            barangaySelect.disabled = false;
            debug('Barangays loaded successfully!', 'success');
            
        } catch (error) {
            debug(`Error loading barangays: ${error.message}`, 'error');
            barangaySelect.innerHTML = '<option value="">Error loading barangays</option>';
        }
    }

    // Initialize on page load
    window.onload = async () => {
        debug('Page loaded, initializing PSA API...');
        await initializeProvinces();
    };
    </script>
</body>
</html>
